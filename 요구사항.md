# 도서관 관리 시스템 요구사항 명세

> 이 문서는 도서관 관리 시스템의 비즈니스 요구사항을 기능별로 정리한 것입니다.

## 목차

- [1. 개요](#1-개요)
- [2. 용어 정의](#2-용어-정의)
- [3. 이용자 유형](#3-이용자-유형)
- [4. 기능 요구사항](#4-기능-요구사항)
  - [4.1 책 예약 (Book Holding)](#41-책-예약-book-holding)
  - [4.2 예약 취소 (Hold Cancellation)](#42-예약-취소-hold-cancellation)
  - [4.3 책 대출 (Book Checkout)](#43-책-대출-book-checkout)
  - [4.4 책 반납 (Book Return)](#44-책-반납-book-return)
  - [4.5 예약 만료 (Hold Expiration)](#45-예약-만료-hold-expiration)
  - [4.6 연체 대출 등록 (Overdue Checkout Registration)](#46-연체-대출-등록-overdue-checkout-registration)
  - [4.7 카탈로그 관리 (Catalogue Management)](#47-카탈로그-관리-catalogue-management)
  - [4.8 이용자 프로필 (Patron Profile)](#48-이용자-프로필-patron-profile)
- [5. 비기능 요구사항](#5-비기능-요구사항)

---

## 1. 개요

공공 도서관 관리 시스템은 이용자가 다양한 도서관 지점에서 책을 예약, 대출, 반납할 수 있도록 하는 시스템입니다. 시스템은 이용자 유형에 따른 권한 관리, 예약 제한, 연체 관리 등의 비즈니스 규칙을 강제합니다.

### 주요 목표

- 이용자 유형(일반/연구자)에 따른 차별화된 서비스 제공
- 책의 가용성 관리 및 예약 시스템 운영
- 공정한 이용을 위한 제한 규칙 적용
- 연체 및 수수료 관리

---

## 2. 용어 정의

### 핵심 용어

| 용어 | 영문 | 설명 |
|-----|------|------|
| **이용자** | Patron | 도서관 시스템을 사용하는 사람 (일반 이용자 또는 연구자) |
| **예약** | Hold | 이용자가 특정 책을 대출하기 위해 사전에 확보하는 행위 |
| **대출** | Checkout | 이용자가 책을 실제로 빌려가는 행위 |
| **반납** | Return | 대출한 책을 도서관에 돌려주는 행위 |
| **일반 도서** | Circulating Book | 모든 이용자가 예약/대출할 수 있는 일반 책 |
| **제한 도서** | Restricted Book | 연구자만 예약/대출할 수 있는 제한된 책 |
| **도서관 지점** | Library Branch | 책이 물리적으로 보관되어 있는 도서관 위치 |
| **카탈로그** | Catalogue | 도서관에서 관리하는 책들의 목록 |
| **일일 시트** | Daily Sheet | 매일 확인해야 하는 예약 만료 및 연체 대출 목록 |

### 예약 유형

| 용어 | 영문 | 설명 |
|-----|------|------|
| **무기한 예약** | Open-ended Hold | 종료일 없이 이용자가 대출할 때까지 유효한 예약 (연구자만 가능) |
| **기한 예약** | Close-ended Hold | 명확한 종료일이 있는 예약 (최대 60일) |

### 상태 정의

| 용어 | 영문 | 설명 |
|-----|------|------|
| **가용 가능** | Available | 현재 예약 가능한 상태의 책 |
| **예약 중** | On Hold | 누군가에 의해 예약된 상태 |
| **대출 중** | Checked Out | 누군가에 의해 대출된 상태 |
| **연체 중** | Overdue | 반납 기한이 지난 대출 상태 |
| **만료됨** | Expired | 기한 내 대출되지 않아 무효화된 예약 |

---

## 3. 이용자 유형

### 3.1 일반 이용자 (Regular Patron)

**권한**:
- 일반 도서만 예약/대출 가능
- 기한 예약(Close-ended Hold)만 가능
- 동시 예약 최대 5권까지

**제약**:
- ❌ 제한 도서 예약 불가
- ❌ 무기한 예약 불가
- ❌ 동일 지점에서 2회 이상 연체 시 해당 지점 예약 불가

### 3.2 연구자 이용자 (Researcher Patron)

**권한**:
- 모든 도서(일반 + 제한) 예약/대출 가능
- 무기한 예약 가능
- 동시 예약 수량 제한 없음

**제약**:
- ❌ 2회 이상 연체 시 예약 불가 (일반 이용자와 동일)

---

## 4. 기능 요구사항

### 4.1 책 예약 (Book Holding)

#### 기능 설명
이용자가 특정 도서관 지점에 있는 책을 예약하여 대출 권한을 확보하는 기능

#### 입력 정보
- 이용자 ID (Patron ID)
- 책 ID (Book ID)
- 도서관 지점 ID (Library Branch ID)
- 예약 기간 (선택적, 일수 또는 무기한)

#### 성공 조건

**공통 조건** (모든 이용자):
- ✅ 책이 해당 지점에서 가용 가능한 상태여야 함
- ✅ 이용자가 해당 지점에서 연체 대출이 2회 미만이어야 함

**일반 이용자 추가 조건**:
- ✅ 현재 예약 수가 5개 미만이어야 함
- ✅ 일반 도서만 예약 가능
- ✅ 기한 예약만 가능 (1~60일)

**연구자 이용자 추가 조건**:
- ✅ 모든 도서(일반 + 제한) 예약 가능
- ✅ 무기한 예약 가능
- ✅ 예약 수량 제한 없음

#### 실패 조건 및 오류 메시지

| 실패 사유 | 오류 메시지 | 적용 대상 |
|----------|------------|----------|
| 책이 가용 불가 | `Book is not available` | 모든 이용자 |
| 연체 2회 이상 | `Patron has too many overdue checkouts at this branch` | 모든 이용자 |
| 예약 5권 초과 | `Regular patron cannot hold more than 5 books` | 일반 이용자 |
| 제한 도서 예약 시도 | `Regular patron cannot hold restricted books` | 일반 이용자 |
| 무기한 예약 시도 | `Regular patron cannot place open-ended holds` | 일반 이용자 |

#### 이벤트
- **성공**: `BookPlacedOnHold`
  - 포함 정보: patronId, bookId, libraryBranchId, holdTo (종료일, 무기한의 경우 null)
- **실패**: `BookHoldFailed`
  - 포함 정보: patronId, reason (실패 사유)

#### 비즈니스 규칙 (Policy)
1. `onlyResearcherCanHoldRestrictedBooks`: 제한 도서는 연구자만 예약 가능
2. `regularPatronMaximumNumberOfHolds`: 일반 이용자는 최대 5권까지만 예약 가능
3. `regularPatronCannotPlaceOpenEndedHolds`: 일반 이용자는 무기한 예약 불가
4. `patronWithTooManyOverdueCheckoutsCannotHold`: 2회 이상 연체 시 예약 불가

---

### 4.2 예약 취소 (Hold Cancellation)

#### 기능 설명
이용자가 자신의 예약을 취소하는 기능

#### 입력 정보
- 이용자 ID (Patron ID)
- 책 ID (Book ID)

#### 성공 조건
- ✅ 예약이 존재해야 함
- ✅ 본인의 예약이어야 함
- ✅ 이미 취소되지 않은 예약이어야 함
- ✅ 이미 대출되지 않은 예약이어야 함

#### 실패 조건 및 오류 메시지

| 실패 사유 | 오류 메시지 |
|----------|------------|
| 예약이 없음 | `Hold does not exist` |
| 다른 사람의 예약 | `Cannot cancel another patron's hold` |
| 이미 취소됨 | `Hold has already been cancelled` |
| 이미 대출됨 | `Cannot cancel a checked-out hold` |

#### 이벤트
- **성공**: `BookHoldCanceled`
- **실패**: `BookHoldCancellingFailed`

#### 부수 효과
- 예약 취소 후, 이용자는 다시 예약 가능 (5권 제한이 완화됨)

---

### 4.3 책 대출 (Book Checkout)

#### 기능 설명
예약한 책을 실제로 대출하는 기능

#### 입력 정보
- 이용자 ID (Patron ID)
- 책 ID (Book ID)

#### 성공 조건
- ✅ 유효한 예약이 존재해야 함
- ✅ 본인의 예약이어야 함
- ✅ 책이 도서관에 실제로 존재해야 함 (분실/훼손되지 않음)

#### 실패 조건 및 오류 메시지

| 실패 사유 | 오류 메시지 |
|----------|------------|
| 예약이 없음 | `No hold exists for this book` |
| 다른 사람의 예약 | `Cannot checkout another patron's hold` |
| 책이 분실/훼손 | `Book is not available for checkout` |
| 예약이 만료됨 | `Hold has expired` |

#### 이벤트
- **성공**: `BookCheckedOut`
  - 포함 정보: patronId, bookId, checkoutDate, dueDate (최대 60일 후)
- **실패**: `BookCheckoutFailed`

#### 비즈니스 규칙
- 대출 기간은 최대 60일
- 대출 시점에 예약은 '완료(Completed)' 상태로 변경됨

---

### 4.4 책 반납 (Book Return)

#### 기능 설명
대출한 책을 도서관에 반납하는 기능

#### 입력 정보
- 이용자 ID (Patron ID)
- 책 ID (Book ID)

#### 성공 조건
- ✅ 유효한 대출이 존재해야 함
- ✅ 본인의 대출이어야 함

#### 이벤트
- **성공**: `BookReturned`
  - 포함 정보: patronId, bookId, returnDate

#### 부수 효과
1. 연체 상태였다면 연체 등록 해제
2. 수수료 계산 프로세스 시작 (연체 수수료, 사용 수수료 등)
3. 책이 다시 가용 가능 상태로 변경됨

---

### 4.5 예약 만료 (Hold Expiration)

#### 기능 설명
기한 예약(Close-ended Hold)이 기한 내에 대출되지 않으면 자동으로 만료시키는 배치 프로세스

#### 실행 시점
- 매일 시작 시점 (Daily Sheet 확인)

#### 처리 대상
- 기한 예약(Close-ended Hold) 중 종료일이 지난 예약
- 아직 대출되지 않은 예약
- 이미 취소되지 않은 예약

#### 제외 대상
- ❌ 무기한 예약 (Open-ended Hold)은 만료되지 않음
- ❌ 이미 대출된 예약
- ❌ 이미 취소된 예약

#### 이벤트
- `BookHoldExpired`
  - 포함 정보: patronId, bookId, holdTo (만료일)

#### 비즈니스 규칙
- 예약은 한 번만 만료 처리됨 (중복 만료 방지)
- 만료된 예약은 이용자의 예약 카운트에서 제외됨

---

### 4.6 연체 대출 등록 (Overdue Checkout Registration)

#### 기능 설명
반납 기한이 지난 대출을 연체 상태로 등록하는 배치 프로세스

#### 실행 시점
- 매일 시작 시점 (Daily Sheet 확인)

#### 처리 대상
- 반납 기한(dueDate)이 현재 날짜보다 이전인 대출
- 아직 반납되지 않은 대출

#### 제외 대상
- ❌ 이미 반납된 대출
- ❌ 이미 연체 등록된 대출 (중복 등록 방지)

#### 이벤트
- `OverdueCheckoutRegistered`
  - 포함 정보: patronId, bookId, libraryBranchId, dueDate

#### 부수 효과
- 동일 지점에서 연체 2회 이상 시, 해당 지점에서 새로운 예약 불가

---

### 4.7 카탈로그 관리 (Catalogue Management)

#### 4.7.1 책 추가

**기능 설명**: 카탈로그에 새로운 책 정보 추가

**입력 정보**:
- ISBN (고유 식별자)
- 제목 (비어있지 않아야 함)
- 저자
- 가격 (필수)

**성공 조건**:
- ✅ ISBN이 고유해야 함 (중복 불가)
- ✅ 제목이 비어있지 않아야 함
- ✅ 가격 정보가 있어야 함

**이벤트**:
- `BookAddedToCatalogue`

#### 4.7.2 책 인스턴스 추가

**기능 설명**: 동일한 ISBN의 물리적 책 인스턴스를 추가

**입력 정보**:
- ISBN (카탈로그에 이미 존재해야 함)
- 책 유형 (일반 도서 또는 제한 도서)
- 도서관 지점 ID

**성공 조건**:
- ✅ 해당 ISBN이 카탈로그에 존재해야 함

**실패 조건**:
- ❌ ISBN이 카탈로그에 없으면 인스턴스 추가 불가

**이벤트**:
- **성공**: `BookInstanceAddedToCatalogue`
- **실패**: `BookInstanceAddingFailed`

**비즈니스 규칙**:
- 동일한 ISBN의 책을 일반 도서와 제한 도서로 동시에 보유 가능
  - 예: 저자 서명본은 제한 도서로, 일반 판본은 일반 도서로 등록

---

### 4.8 이용자 프로필 (Patron Profile)

#### 기능 설명
이용자가 자신의 현재 예약 및 대출 정보를 조회하는 기능

#### 조회 가능 정보

**현재 예약 (Current Holds)**:
- 활성화된 예약 목록 (취소되지 않고 만료되지 않은 예약)
- 각 예약의 상태 (대기 중, 대출 준비 완료 등)
- 예약 종료일 (기한 예약의 경우)

**현재 대출 (Current Checkouts)**:
- 대출 중인 책 목록
- 반납 기한
- 연체 여부

**제공 기능**:
- 예약하기 (Place Hold)
- 예약 취소하기 (Cancel Hold)
- 대출 내역 조회
- 연체 내역 조회

---

## 5. 비기능 요구사항

### 5.1 아키텍처

- **Lending Context**: 헥사고날 아키텍처(Hexagonal Architecture) 적용
  - Domain 레이어는 프레임워크 독립적
  - Application 레이어에서 유스케이스 조율
  - Infrastructure 레이어에서 기술 구현
- **Catalogue Context**: 단순 CRUD 구조

### 5.2 데이터 일관성

- **Patron Aggregate**: 강한 일관성(Strong Consistency)
  - 예약 수량 제한, 연체 확인 등은 즉시 반영되어야 함
- **Book Aggregate**: 최종 일관성(Eventual Consistency)
  - 책의 가용성은 "최선의 추측(best guess)"
  - 실제 물리적 상태(분실, 훼손)와 차이 가능
  - 보상 프로세스를 통해 해결

### 5.3 도메인 이벤트

- 모든 중요한 비즈니스 사실은 Domain Event로 발행
- 이벤트는 불변(Immutable)이며 과거형으로 명명
- 이벤트를 통한 느슨한 결합 구현

### 5.4 테스트

- Domain 레이어: 빠른 단위 테스트 (외부 의존성 없음)
- Application 레이어: 통합 테스트 (Mocked Repository)
- E2E 테스트: 전체 플로우 검증

### 5.5 확장성

- Bounded Context 간 명확한 경계
- 각 Context는 독립적으로 확장 가능
- 이벤트 기반 통신으로 느슨한 결합 유지

---

## 부록 A: 주요 유스케이스 플로우

### A.1 책 예약 플로우

```
1. 이용자가 책 검색 및 선택
2. 시스템이 책의 가용성 확인
3. 시스템이 이용자의 예약 가능 여부 확인
   - 연체 상태 확인
   - 예약 수량 제한 확인
   - 책 유형 및 이용자 권한 확인
4. Policy 검증
5-a. 성공: BookPlacedOnHold 이벤트 발행
5-b. 실패: BookHoldFailed 이벤트 발행 및 사유 반환
6. 이용자 Aggregate 저장
```

### A.2 예약 만료 배치 플로우

```
1. 매일 00:00시 자동 실행
2. Daily Sheet에서 만료 대상 조회
   - holdTo < 현재 날짜
   - 대출되지 않음
   - 취소되지 않음
3. 각 예약에 대해 만료 처리
4. BookHoldExpired 이벤트 발행
5. 책 상태를 '가용 가능'으로 변경
```

---

## 부록 B: 정책 매트릭스

### 예약 가능 여부 매트릭스

| 조건 | 일반 이용자 | 연구자 이용자 |
|------|-------------|--------------|
| 일반 도서 + 기한 예약 + 예약 5개 미만 + 연체 2회 미만 | ✅ 가능 | ✅ 가능 |
| 일반 도서 + 기한 예약 + 예약 5개 이상 | ❌ 불가 | ✅ 가능 |
| 제한 도서 | ❌ 불가 | ✅ 가능 |
| 무기한 예약 | ❌ 불가 | ✅ 가능 |
| 연체 2회 이상 (동일 지점) | ❌ 불가 | ❌ 불가 |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2025-01-31 | 초기 요구사항 문서 작성 |